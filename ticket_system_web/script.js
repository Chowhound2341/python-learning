// 47Ê∏∏‰πêÂõ≠Èó®Á•®Á≥ªÁªü JavaScript
class TicketSystem {
    constructor() {
        this.ticketPrices = {
            'INFANT': 0,      // Â©¥ÂπºÂÑø
            'CHILD': 0,       // ÂÑøÁ´•
            'STUDENT': 30,    // Â≠¶Áîü
            'ADULT': 68,      // Êàê‰∫∫
            'SENIOR': 34,     // ËÄÅ‰∫∫
            'DISABLED': 0     // ÊÆãÁñæ‰∫∫
        };
        
        this.ticketTypeNames = {
            'INFANT': 'Â©¥ÂπºÂÑø',
            'CHILD': 'ÂÑøÁ´•',
            'STUDENT': 'Â≠¶Áîü',
            'ADULT': 'Êàê‰∫∫',
            'SENIOR': 'ËÄÅ‰∫∫',
            'DISABLED': 'ÊÆãÁñæ‰∫∫'
        };
        
        this.visitHistory = [];
        this.dailyStats = {
            totalVisitors: 0,
            totalRevenue: 0
        };
        
        this.init();
    }
    
    init() {
        this.updateDateTime();
        this.setupEventListeners();
        this.updateStats();
        
        // ÊØèÂàÜÈíüÊõ¥Êñ∞Êó∂Èó¥
        setInterval(() => {
            this.updateDateTime();
        }, 60000);
    }
    
    updateDateTime() {
        const now = new Date();
        const dateTimeElement = document.getElementById('current-date-time');
        const weatherElement = document.getElementById('weather-status');
        
        const options = {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            weekday: 'long',
            hour: '2-digit',
            minute: '2-digit'
        };
        
        const dateTimeString = now.toLocaleDateString('zh-CN', options);
        dateTimeElement.textContent = dateTimeString;
        
        // Ê†πÊçÆÊó∂Èó¥ÊòæÁ§∫Â§©Ê∞îÁä∂ÊÄÅ
        const hour = now.getHours();
        const weatherEmoji = hour < 18 ? '‚òÄÔ∏è' : 'üåô';
        weatherElement.textContent = weatherEmoji;
    }
    
    setupEventListeners() {
        const form = document.getElementById('ticket-purchase-form');
        const newTicketBtn = document.getElementById('new-ticket-btn');
        
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleTicketPurchase();
        });
        
        newTicketBtn.addEventListener('click', () => {
            this.resetForm();
        });
    }
    
    handleTicketPurchase() {
        const age = parseInt(document.getElementById('age').value);
        const isStudent = document.getElementById('is-student').checked;
        const isDisabled = document.getElementById('is-disabled').checked;
        
        if (!this.validateAge(age)) {
            return;
        }
        
        const ticketInfo = this.generateTicket(age, isStudent, isDisabled);
        this.displayTicket(ticketInfo);
        this.saveVisitRecord(ticketInfo);
        this.updateStats();
        
        // Âπ≥ÊªëÊªöÂä®Âà∞Èó®Á•®ÊòæÁ§∫Âå∫Âüü
        document.getElementById('ticket-display').scrollIntoView({
            behavior: 'smooth'
        });
    }
    
    validateAge(age) {
        if (isNaN(age) || age < 0) {
            alert('‚ùå ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÂπ¥ÈæÑÔºÅ');
            return false;
        }
        
        if (age > 150) {
            return confirm('‚ö†Ô∏è Âπ¥ÈæÑËæìÂÖ•ËøáÂ§ßÔºåËØ∑Á°ÆËÆ§ÊòØÂê¶Ê≠£Á°ÆÔºü');
        }
        
        return true;
    }
    
    determineTicketType(age, isStudent, isDisabled) {
        if (isDisabled) {
            return 'DISABLED';
        } else if (age < 3) {
            return 'INFANT';
        } else if (age < 18) {
            return 'CHILD';
        } else if (age < 25 && isStudent) {
            return 'STUDENT';
        } else if (age < 60) {
            return 'ADULT';
        } else {
            return 'SENIOR';
        }
    }
    
    applySpecialDiscounts(ticketInfo) {
        const now = new Date();
        const weekday = now.getDay(); // 0ÊòØÂë®Êó•Ôºå1-6ÊòØÂë®‰∏ÄÂà∞Âë®ÂÖ≠
        const hour = now.getHours();
        
        let discount = 0;
        const specialNotes = [];
        
        // Â∑•‰ΩúÊó•ÊäòÊâ£ÔºàÂë®‰∏ÄÂà∞Âë®ÂõõÔºâ
        if (weekday >= 1 && weekday <= 4 && ticketInfo.ticketType === 'ADULT') {
            discount += 0.1;
            specialNotes.push('Â∑•‰ΩúÊó•‰ºòÊÉ†Ôºö9Êäò');
        }
        
        // Êó©È∏ü‰ºòÊÉ†Ôºà‰∏äÂçà10ÁÇπÂâçÔºâ
        if (hour < 10 && ticketInfo.basePrice > 0) {
            discount += 0.05;
            specialNotes.push('Êó©È∏ü‰ºòÊÉ†ÔºöÈ¢ùÂ§ñ5%ÊäòÊâ£');
        }
        
        // ËäÇÂÅáÊó•Ê∂®‰ª∑ÔºàÂë®ÂÖ≠Êó•Ôºâ
        if (weekday === 0 || weekday === 6) {
            if (ticketInfo.ticketType === 'ADULT' || ticketInfo.ticketType === 'STUDENT') {
                ticketInfo.basePrice *= 1.2;
                specialNotes.push('Âë®Êú´Á•®‰ª∑Ôºö+20%');
            }
        }
        
        ticketInfo.discount = discount;
        ticketInfo.specialNotes = specialNotes;
        ticketInfo.finalPrice = ticketInfo.basePrice * (1 - discount);
        
        return ticketInfo;
    }
    
    generateTicket(age, isStudent, isDisabled) {
        const ticketType = this.determineTicketType(age, isStudent, isDisabled);
        const basePrice = this.ticketPrices[ticketType];
        
        let ticketInfo = {
            age: age,
            ticketType: ticketType,
            basePrice: basePrice,
            discount: 0,
            finalPrice: basePrice,
            specialNotes: []
        };
        
        // Â∫îÁî®ÁâπÊÆäÊäòÊâ£
        ticketInfo = this.applySpecialDiscounts(ticketInfo);
        
        return ticketInfo;
    }
    
    displayTicket(ticketInfo) {
        const ticketDisplay = document.getElementById('ticket-display');
        const now = new Date();
        
        // ÁîüÊàêÁ•®Âè∑
        const ticketId = `47-${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}-${(this.visitHistory.length + 1).toString().padStart(4, '0')}`;
        
        // Â°´ÂÖÖÈó®Á•®‰ø°ÊÅØ
        document.getElementById('ticket-id').textContent = ticketId;
        document.getElementById('ticket-age').textContent = `${ticketInfo.age}Â≤Å`;
        document.getElementById('ticket-type').textContent = this.ticketTypeNames[ticketInfo.ticketType];
        document.getElementById('ticket-date').textContent = now.toLocaleString('zh-CN');
        
        // ‰ª∑Ê†º‰ø°ÊÅØ
        if (ticketInfo.basePrice === 0) {
            document.getElementById('ticket-price').textContent = 'üÜì ÂÖçË¥πÂÖ•Âõ≠';
            document.getElementById('discount-info').style.display = 'none';
        } else {
            if (ticketInfo.discount > 0) {
                document.getElementById('original-price').textContent = `¬•${Math.round(ticketInfo.basePrice)}`;
                document.getElementById('discount-percent').textContent = `${Math.round(ticketInfo.discount * 100)}%`;
                document.getElementById('final-price').textContent = `¬•${Math.round(ticketInfo.finalPrice)}`;
                document.getElementById('ticket-price').textContent = `¬•${Math.round(ticketInfo.finalPrice)}`;
                document.getElementById('discount-info').style.display = 'block';
            } else {
                document.getElementById('ticket-price').textContent = `¬•${Math.round(ticketInfo.finalPrice)}`;
                document.getElementById('discount-info').style.display = 'none';
            }
        }
        
        // ÁâπÊÆäËØ¥Êòé
        if (ticketInfo.specialNotes && ticketInfo.specialNotes.length > 0) {
            const notesList = document.getElementById('notes-list');
            notesList.innerHTML = '';
            ticketInfo.specialNotes.forEach(note => {
                const li = document.createElement('li');
                li.textContent = note;
                notesList.appendChild(li);
            });
            document.getElementById('special-notes').style.display = 'block';
        } else {
            document.getElementById('special-notes').style.display = 'none';
        }
        
        // ÁîüÊàê‰∫åÁª¥Á†ÅËâ∫ÊúØ
        this.generateQRCode();
        
        // ÊòæÁ§∫Èó®Á•®Âπ∂Ê∑ªÂä†Âä®Áîª
        ticketDisplay.style.display = 'block';
        ticketDisplay.classList.add('bounce-in');
        
        // ÈöêËóèË°®Âçï
        document.querySelector('.ticket-form').style.display = 'none';
    }
    
    generateQRCode() {
        const qrArt = [
            "‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    ‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà",
            "‚ñà‚ñà          ‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà          ‚ñà‚ñà",
            "‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà    ‚ñà‚ñà  ‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà",
            "‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà  ‚ñà‚ñà    ‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà",
            "‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà    ‚ñà‚ñà  ‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà",
            "‚ñà‚ñà          ‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà          ‚ñà‚ñà",
            "‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà",
            "                ‚ñà‚ñà                  ",
            "‚ñà‚ñà  ‚ñà‚ñà    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    ‚ñà‚ñà    ‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà  ",
            "    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    ‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà    ‚ñà‚ñà",
            "‚ñà‚ñà    ‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    ‚ñà‚ñà  ‚ñà‚ñà    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà",
            "‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    ‚ñà‚ñà  ",
            "‚ñà‚ñà          ‚ñà‚ñà    ‚ñà‚ñà    ‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà    ",
            "‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà",
            "‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà      ‚ñà‚ñà    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà",
            "‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà  ‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    ‚ñà‚ñà    ",
            "‚ñà‚ñà          ‚ñà‚ñà    ‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà",
            "‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    ‚ñà‚ñà    ‚ñà‚ñà  ‚ñà‚ñà    ‚ñà‚ñà"
        ];
        
        document.getElementById('qr-code').textContent = qrArt.join('\n');
    }
    
    saveVisitRecord(ticketInfo) {
        const visitRecord = {
            timestamp: new Date().toISOString(),
            age: ticketInfo.age,
            ticketType: ticketInfo.ticketType,
            price: ticketInfo.finalPrice,
            discounts: ticketInfo.specialNotes
        };
        
        this.visitHistory.push(visitRecord);
        this.dailyStats.totalVisitors += 1;
        this.dailyStats.totalRevenue += ticketInfo.finalPrice;
    }
    
    updateStats() {
        document.getElementById('total-visitors').textContent = this.dailyStats.totalVisitors;
        document.getElementById('total-revenue').textContent = `¬•${Math.round(this.dailyStats.totalRevenue)}`;
        
        if (this.dailyStats.totalVisitors > 0) {
            const avgPrice = this.dailyStats.totalRevenue / this.dailyStats.totalVisitors;
            document.getElementById('avg-price').textContent = `¬•${Math.round(avgPrice)}`;
        } else {
            document.getElementById('avg-price').textContent = '¬•0';
        }
    }
    
    resetForm() {
        // ÊòæÁ§∫Ë°®Âçï
        document.querySelector('.ticket-form').style.display = 'block';
        
        // ÈöêËóèÈó®Á•®ÊòæÁ§∫
        document.getElementById('ticket-display').style.display = 'none';
        
        // ÈáçÁΩÆË°®Âçï
        document.getElementById('ticket-purchase-form').reset();
        
        // ÊªöÂä®Âà∞Ë°®Âçï
        document.querySelector('.ticket-form').scrollIntoView({
            behavior: 'smooth'
        });
    }
}

// È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñÁ≥ªÁªü
document.addEventListener('DOMContentLoaded', () => {
    // Ê∑ªÂä†Âä†ËΩΩÂä®Áîª
    document.body.classList.add('fade-in');
    
    // ÂàùÂßãÂåñÈó®Á•®Á≥ªÁªü
    const ticketSystem = new TicketSystem();
    
    // Ê∑ªÂä†‰∏Ä‰∫õ‰∫§‰∫íÊïàÊûú
    addInteractiveEffects();
});

function addInteractiveEffects() {
    // ‰∏∫ÊâÄÊúâÊåâÈíÆÊ∑ªÂä†ÁÇπÂáªÊïàÊûú
    const buttons = document.querySelectorAll('button');
    buttons.forEach(button => {
        button.addEventListener('click', function(e) {
            const ripple = document.createElement('span');
            const rect = this.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = e.clientX - rect.left - size / 2;
            const y = e.clientY - rect.top - size / 2;
            
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = x + 'px';
            ripple.style.top = y + 'px';
            ripple.classList.add('ripple');
            
            this.appendChild(ripple);
            
            setTimeout(() => {
                ripple.remove();
            }, 600);
        });
    });
    
    // ‰∏∫Ë°®ÂçïËæìÂÖ•Ê∑ªÂä†ÁÑ¶ÁÇπÊïàÊûú
    const inputs = document.querySelectorAll('input');
    inputs.forEach(input => {
        input.addEventListener('focus', function() {
            this.parentElement.classList.add('focused');
        });
        
        input.addEventListener('blur', function() {
            this.parentElement.classList.remove('focused');
        });
    });
    
    // Ê∑ªÂä†Èº†Ê†áË∑üÈöèÊïàÊûú
    document.addEventListener('mousemove', (e) => {
        const cursor = document.querySelector('.cursor');
        if (!cursor) {
            const newCursor = document.createElement('div');
            newCursor.className = 'cursor';
            document.body.appendChild(newCursor);
        }
    });
}

// Ê∑ªÂä†Ëá™ÂÆö‰πâCSSÂä®ÁîªÊ†∑Âºè
const style = document.createElement('style');
style.textContent = `
    .ripple {
        position: absolute;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.6);
        transform: scale(0);
        animation: ripple-animation 0.6s linear;
        pointer-events: none;
    }
    
    @keyframes ripple-animation {
        to {
            transform: scale(4);
            opacity: 0;
        }
    }
    
    .focused {
        transform: translateY(-2px);
        transition: transform 0.3s ease;
    }
    
    .cursor {
        width: 20px;
        height: 20px;
        border: 2px solid #667eea;
        border-radius: 50%;
        position: fixed;
        pointer-events: none;
        z-index: 9999;
        transform: translate(-50%, -50%);
        transition: transform 0.1s ease;
    }
`;
document.head.appendChild(style);
